{% extends 'base.html' %}

{% block title %}{{ story.title }} - NAHB{% endblock %}

{% block content %}
<div class="card">
    <h1>{{ story.title }}</h1>
    <p style="color: #666; font-size: 1.1rem; margin-bottom: 2rem;">{{ story.description }}</p>
    
    <!-- Average Rating Display -->
    {% if avg_rating %}
    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: inline-block;">
        <span style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">
            ⭐ {{ avg_rating }} / 5
        </span>
        <span style="color: #666; margin-left: 0.5rem;">({{ total_ratings }} ratings)</span>
    </div>
    {% endif %}
    
    <h3>Statistics</h3>
    <p><strong>Total Plays:</strong> {{ total_plays }}</p>
    
    {% if endings_stats %}
    <h4>Ending Distribution:</h4>
    <table>
        <thead>
            <tr>
                <th>Ending Page ID</th>
                <th>Times Reached</th>
            </tr>
        </thead>
        <tbody>
            {% for ending in endings_stats %}
            <tr>
                <td>{{ ending.ending_page_id }}</td>
                <td>{{ ending.count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
    
    <div style="margin-top: 2rem;">
        <a href="{% url 'play_story' story.id %}" class="btn btn-success">Play This Story</a>
        <a href="{% url 'story_list' %}" class="btn">Back to Stories</a>
    </div>
</div>

<!-- Rating Section -->
<div class="card">
    <h2>Rate This Story</h2>
    
    {% if user_rating %}
    <div style="background: #d4edda; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
        <strong>Your Rating: ⭐ {{ user_rating.stars }} / 5</strong>
        {% if user_rating.comment %}
        <p style="margin-top: 0.5rem;">{{ user_rating.comment }}</p>
        {% endif %}
        <small style="color: #666;">You can submit again to update your rating</small>
    </div>
    {% endif %}
    
    <form method="post" action="{% url 'rate_story' story.id %}">
        {% csrf_token %}
        
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem;">Your Rating:</label>
            <div style="display: flex; gap: 0.5rem;">
                {% for i in "12345" %}
                <label style="cursor: pointer; font-size: 2rem;">
                    <input type="radio" name="stars" value="{{ i }}" required 
                           {% if user_rating.stars == i|add:0 %}checked{% endif %}
                           style="display: none;">
                    <span class="star" data-value="{{ i }}">⭐</span>
                </label>
                {% endfor %}
            </div>
        </div>
        
        <div>
            <label for="comment">Comment (optional):</label>
            <textarea id="comment" name="comment" rows="3" 
                      placeholder="Share your thoughts...">{% if user_rating %}{{ user_rating.comment }}{% endif %}</textarea>
        </div>
        
        <button type="submit" class="btn btn-success">Submit Rating</button>
    </form>
</div>

<!-- All Ratings -->
<div class="card">
    <h2>User Ratings ({{ ratings.count }})</h2>
    
    {% if ratings %}
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for rating in ratings %}
        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <strong>{{ rating.user.username }}</strong>
                <span style="color: #f39c12; font-size: 1.2rem;">
                    {% for i in "12345" %}
                        {% if i|add:0 <= rating.stars %}⭐{% else %}☆{% endif %}
                    {% endfor %}
                </span>
            </div>
            {% if rating.comment %}
            <p style="color: #555; margin: 0;">{{ rating.comment }}</p>
            {% endif %}
            <small style="color: #999;">{{ rating.created_at|date:"M d, Y" }}</small>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666;">No ratings yet. Be the first to rate this story!</p>
    {% endif %}
</div>

<style>
.star {
    transition: transform 0.2s;
}
.star:hover {
    transform: scale(1.3);
}
input[type="radio"]:checked + .star {
    filter: brightness(1.2);
}
</style>

<script>
document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function() {
        const value = this.dataset.value;
        document.querySelector(`input[value="${value}"]`).checked = true;
    });
});
</script>

{% endblock %}